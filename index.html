<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Coordenadas Polares AR - Quest 3</title>
<style>
    body { margin: 0; overflow: hidden; }
</style>

<!-- Three.js clásico (no módulo) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
</head>
<body>

<script>
/* ===========================================================
   ARBUTTON GLOBAL SIN MÓDULOS
=========================================================== */
window.ARButton = function() {};
window.ARButton.createButton = function(renderer, sessionInit) {
    sessionInit = sessionInit || {};
    var button = document.createElement('button');

    function showStartAR() {
        if (sessionInit.domOverlay === undefined) {
            var overlay = document.createElement('div');
            overlay.style.display = 'none';
            document.body.appendChild(overlay);

            var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', 38);
            svg.setAttribute('height', 38);
            svg.style.position = 'absolute';
            svg.style.right = '20px';
            svg.style.top = '20px';
            svg.addEventListener('click', function(){ currentSession.end(); });
            overlay.appendChild(svg);

            var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M 12,12 L 28,28 M 28,12 12,28');
            path.setAttribute('stroke', '#fff');
            path.setAttribute('stroke-width', 2);
            svg.appendChild(path);

            sessionInit.optionalFeatures = sessionInit.optionalFeatures || [];
            sessionInit.optionalFeatures.push('dom-overlay');
            sessionInit.domOverlay = { root: overlay };
        }

        var currentSession = null;

        function onSessionStarted(session) {
            session.addEventListener('end', onSessionEnded);
            renderer.xr.setReferenceSpaceType('local');
            renderer.xr.setSession(session).then(function() {
                button.textContent = 'STOP AR';
                sessionInit.domOverlay.root.style.display = '';
                currentSession = session;
            });
        }

        function onSessionEnded() {
            currentSession.removeEventListener('end', onSessionEnded);
            button.textContent = 'START AR';
            sessionInit.domOverlay.root.style.display = 'none';
            currentSession = null;
        }

        button.style.display = '';
        button.style.cursor = 'pointer';
        button.style.left = 'calc(50% - 50px)';
        button.style.width = '100px';
        button.textContent = 'START AR';

        button.onmouseenter = function() { button.style.opacity = '1.0'; };
        button.onmouseleave = function() { button.style.opacity = '0.5'; };
        button.onclick = function() {
            if (currentSession === null) {
                navigator.xr.requestSession('immersive-ar', sessionInit).then(onSessionStarted);
            } else {
                currentSession.end();
            }
        };
    }

    function disableButton() {
        button.style.display = '';
        button.style.cursor = 'auto';
        button.style.left = 'calc(50% - 75px)';
        button.style.width = '150px';
        button.onmouseenter = null;
        button.onmouseleave = null;
        button.onclick = null;
    }

    function stylizeElement(element) {
        element.style.position = 'absolute';
        element.style.bottom = '20px';
        element.style.padding = '12px 6px';
        element.style.border = '1px solid #fff';
        element.style.borderRadius = '4px';
        element.style.background = 'rgba(0,0,0,0.1)';
        element.style.color = '#fff';
        element.style.font = 'normal 13px sans-serif';
        element.style.textAlign = 'center';
        element.style.opacity = '0.5';
        element.style.outline = 'none';
        element.style.zIndex = '999';
    }

    if ('xr' in navigator) {
        button.id = 'ARButton';
        button.style.display = 'none';
        stylizeElement(button);
        navigator.xr.isSessionSupported('immersive-ar')
            .then(function(supported){ supported ? showStartAR() : disableButton(); })
            .catch(disableButton);
        return button;
    } else {
        var message = document.createElement('a');
        message.href = window.isSecureContext ? 'https://immersiveweb.dev/' : document.location.href.replace(/^http:/,'https:');
        message.innerHTML = window.isSecureContext ? 'WEBXR NOT AVAILABLE' : 'WEBXR NEEDS HTTPS';
        message.style.left = 'calc(50% - 90px)';
        message.style.width = '180px';
        stylizeElement(message);
        return message;
    }
};

/* ===========================================================
   ESCENA, CÁMARA Y RENDERER
=========================================================== */
var scene = new THREE.Scene();

var camera = new THREE.PerspectiveCamera(
    70,
    window.innerWidth / window.innerHeight,
    0.01,
    1000
);

var renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
renderer.xr.setReferenceSpaceType("local-floor");
document.body.appendChild(renderer.domElement);

/* ===========================================================
   BOTÓN AR
=========================================================== */
const button = window.ARButton.createButton(renderer, { requiredFeatures: ["local-floor"] });
document.body.appendChild(button);

// Ajustar malla polar al piso después de iniciar sesión AR
renderer.xr.addEventListener('sessionstart', () => {
    // mover todo el grupo al piso
    polarGroup.position.y = 0; // 0 = piso real en local-floor
});


/* ===========================================================
   MALLA POLAR EN EL PISO (COLORES POR CUADRANTE)
=========================================================== */
var polarGroup = new THREE.Group();

// círculos (celeste)
for (var r = 0.5; r <= 5; r += 0.5){
    var pts = [];
    for (var deg = 0; deg < 360; deg++){
        var rad = THREE.MathUtils.degToRad(deg);
        pts.push(new THREE.Vector3(r * Math.cos(rad), 0, r * Math.sin(rad)));
    }
    var geometry = new THREE.BufferGeometry().setFromPoints(pts);
    var material = new THREE.LineBasicMaterial({ color: 0x00ffff });
    polarGroup.add(new THREE.LineLoop(geometry, material));
}

// radiales con colores por cuadrante
var quadrantColors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00]; // rojo, verde, azul, amarillo

for (var deg = 0; deg < 360; deg += 15){
    var rad = THREE.MathUtils.degToRad(deg);
    var geometry = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(5 * Math.cos(rad), 0, 5 * Math.sin(rad))
    ]);

    // determinar el cuadrante
    var quadrant = Math.floor(deg / 90); // 0,1,2,3
    var material = new THREE.LineBasicMaterial({ color: quadrantColors[quadrant] });

    polarGroup.add(new THREE.Line(geometry, material));
}

// colocar la malla al piso
polarGroup.position.y = -1.5;

scene.add(polarGroup);


/* ===========================================================
   LOOP DE RENDER
=========================================================== */
renderer.setAnimationLoop(function() {
    renderer.render(scene,camera);
});
</script>

</body>
</html>
