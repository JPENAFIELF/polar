<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Coordenadas Polares AR - Quest 3</title>
<style>
    body { margin: 0; overflow: hidden; }
</style>

<!-- Three.js GLOBAL (NO MODULE) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>

</head>
<body>

<script>
/* ===========================================================
   ESCENA, CÁMARA Y RENDERER
=========================================================== */
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
    70,
    window.innerWidth / window.innerHeight,
    0.01,
    1000
);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
renderer.xr.setReferenceSpaceType("local-floor");
document.body.appendChild(renderer.domElement);

/* ===========================================================
   BOTÓN AR (USANDO TU ARBUTTON SIN MÓDULOS)
=========================================================== */
document.body.appendChild(
    ARButton.createButton(renderer, {
        requiredFeatures: ["local-floor"]
    })
);

/* ===========================================================
   MALLA POLAR EN EL PISO
=========================================================== */
const polarGroup = new THREE.Group();

// CÍRCULOS
for (let r = 0.5; r <= 5; r += 0.5) {
    const pts = [];
    for (let deg = 0; deg < 360; deg++) {
        const rad = THREE.MathUtils.degToRad(deg);
        pts.push(new THREE.Vector3(
            r * Math.cos(rad),
            0,
            r * Math.sin(rad)
        ));
    }
    const geometry = new THREE.BufferGeometry().setFromPoints(pts);
    const material = new THREE.LineBasicMaterial({ color: 0x00ffff });
    polarGroup.add(new THREE.LineLoop(geometry, material));
}

// RADIALES
for (let deg = 0; deg < 360; deg += 15) {
    const rad = THREE.MathUtils.degToRad(deg);
    const geometry = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(5 * Math.cos(rad), 0, 5 * Math.sin(rad))
    ]);
    const material = new THREE.LineBasicMaterial({ color: 0xff00aa });
    polarGroup.add(new THREE.Line(geometry, material));
}

scene.add(polarGroup);

/* ===========================================================
   LOOP DE RENDERIZADO
=========================================================== */
renderer.setAnimationLoop(() => renderer.render(scene, camera));
</script>

<script>
/* ===========================================================
   ARBUTTON GLOBAL SIN MÓDULOS (COMPATIBLE CON QUEST 3)
=========================================================== */
window.ARButton = class ARButton {

    static createButton(renderer, sessionInit = {}) {

        const button = document.createElement('button');

        function showStartAR() {

            if (sessionInit.domOverlay === undefined) {

                const overlay = document.createElement('div');
                overlay.style.display = 'none';
                document.body.appendChild(overlay);

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', 38);
                svg.setAttribute('height', 38);
                svg.style.position = 'absolute';
                svg.style.right = '20px';
                svg.style.top = '20px';
                svg.addEventListener('click', () => currentSession.end());
                overlay.appendChild(svg);

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M 12,12 L 28,28 M 28,12 12,28');
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', 2);
                svg.appendChild(path);

                sessionInit.optionalFeatures = sessionInit.optionalFeatures || [];
                sessionInit.optionalFeatures.push('dom-overlay');
                sessionInit.domOverlay = { root: overlay };
            }

            let currentSession = null;

            async function onSessionStarted(session) {

                session.addEventListener('end', onSessionEnded);

                renderer.xr.setReferenceSpaceType('local');

                await renderer.xr.setSession(session);

                button.textContent = 'STOP AR';
                sessionInit.domOverlay.root.style.display = '';

                currentSession = session;
            }

            function onSessionEnded() {

                currentSession.removeEventListener('end', onSessionEnded);

                button.textContent = 'START AR';
                sessionInit.domOverlay.root.style.display = 'none';

                currentSession = null;
            }

            button.style.display = '';
            button.style.cursor = 'pointer';
            button.style.left = 'calc(50% - 50px)';
            button.style.width = '100px';

            button.textContent = 'START AR';

            button.onmouseenter = () => (button.style.opacity = '1.0');
            button.onmouseleave = () => (button.style.opacity = '0.5');

            button.onclick = () => {
                currentSession === null
                    ? navigator.xr.requestSession('immersive-ar', sessionInit).then(onSessionStarted)
                    : currentSession.end();
            };
        }

        function disableButton() {
            button.style.display = '';
            button.style.cursor = 'auto';
            button.style.left = 'calc(50% - 75px)';
            button.style.width = '150px';
            button.onmouseenter = null;
            button.onmouseleave = null;
            button.onclick = null;
        }

        function stylizeElement(element) {
            element.style.position = 'absolute';
            element.style.bottom = '20px';
            element.style.padding = '12px 6px';
            element.style.border = '1px solid #fff';
            element.style.borderRadius = '4px';
            element.style.background = 'rgba(0,0,0,0.1)';
            element.style.color = '#fff';
            element.style.font = 'normal 13px sans-serif';
            element.style.textAlign = 'center';
            element.style.opacity = '0.5';
            element.style.outline = 'none';
            element.style.zIndex = '999';
        }

        if ('xr' in navigator) {

            button.id = 'ARButton';
            button.style.display = 'none';

            stylizeElement(button);

            navigator.xr.isSessionSupported('immersive-ar')
                .then(supported => (supported ? showStartAR() : disableButton()))
                .catch(disableButton);

            return button;

        } else {

            const message = document.createElement('a');

            message.href = window.isSecureContext
                ? 'https://immersiveweb.dev/'
                : document.location.href.replace(/^http:/, 'https:');

            message.innerHTML = window.isSecureContext
                ? 'WEBXR NOT AVAILABLE'
                : 'WEBXR NEEDS HTTPS';

            message.style.left = 'calc(50% - 90px)';
            message.style.width = '180px';

            stylizeElement(message);

            return message;
        }
    }
};
</script>

</body>
</html>
